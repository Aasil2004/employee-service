# Registration & Login Flow Guide

## Overview
The registration and login system is now fully implemented with the following features:
- **Registration endpoint** that encrypts passwords and validates unique usernames
- **Login endpoint** that authenticates users and returns their details
- **Role-based redirect logic** (ADMINS → `/employees`, USERS → `/profile`)

---

## Implementation Details

### 1. **Employee Entity** (`Employee.java`)
```java
@Column(unique = true, nullable = false)
private String username;
```
- Added `@Column(unique = true, nullable = false)` constraint to ensure usernames are unique
- Database will enforce this constraint, preventing duplicate registrations

### 2. **Registration Endpoint** (`POST /auth/register`)

**Request Body:**
```json
{
  "name": "John Doe",
  "username": "johndoe",
  "password": "securePassword123",
  "role": "USER"  // or "ADMIN"
}
```

**Validation Checks:**
- ✅ Username cannot be empty
- ✅ Username must be unique (checks database)
- ✅ Password cannot be empty
- ✅ Role must exist in database

**Responses:**
- **201 Created**: Registration successful
  ```json
  {
    "success": true,
    "message": "Registration successful",
    "employee": {
      "id": 1,
      "name": "John Doe",
      "username": "johndoe",
      "password": "[encrypted]",
      "role": { "id": 1, "name": "USER" }
    }
  }
  ```

- **400 Bad Request**: Missing/invalid inputs
  ```json
  {
    "success": false,
    "message": "Username cannot be empty"
  }
  ```

- **409 Conflict**: Username already exists
  ```json
  {
    "success": false,
    "message": "Username already exists"
  }
  ```

### 3. **Login Endpoint** (`POST /auth/login`)

**Request Body:**
```json
{
  "username": "johndoe",
  "password": "securePassword123"
}
```

**Response (200 OK):**
```json
{
  "success": true,
  "message": "Login successful",
  "employee": {
    "id": 1,
    "name": "John Doe",
    "username": "johndoe",
    "role": { "id": 1, "name": "USER" }
  }
}
```

**Response (401 Unauthorized):**
```json
{
  "success": false,
  "message": "Invalid username or password"
}
```

### 4. **Role-Based Redirection** (`CustomAuthenticationSuccessHandler.java`)
After successful login via form submission:
- **ADMIN users** → redirected to `/employees` (employee list)
- **USER users** → redirected to `/profile` (profile page)

---

## Testing Instructions

### 1. Start your Spring Boot application
```bash
mvn spring-boot:run
```

### 2. Create some roles first (if not already created)
```bash
POST /role
Content-Type: application/json

{
  "name": "ADMIN",
  "description": "Administrator role"
}
```

### 3. Register a new user
```bash
POST /auth/register
Content-Type: application/json

{
  "name": "Alice Smith",
  "username": "alice",
  "password": "password123",
  "role": "ADMIN"
}
```

### 4. Try registering with duplicate username
```bash
POST /auth/register
Content-Type: application/json

{
  "name": "Bob Smith",
  "username": "alice",
  "password": "different123",
  "role": "USER"
}
```
**Expected Response:** 409 Conflict - "Username already exists"

### 5. Login with registered credentials
```bash
POST /auth/login
Content-Type: application/json

{
  "username": "alice",
  "password": "password123"
}
```

### 6. Verify current user
```bash
GET /auth/current-user
```
Returns the authenticated user's details with their role and authorities.

---

## Security Features

✅ **Password Encryption**: All passwords are hashed using BCrypt (via `PasswordEncoder`)
✅ **Username Uniqueness**: Database constraint + application-level validation
✅ **Authorization**: 
  - `/auth/register` and `/auth/login` are public endpoints
  - `/employees/**` requires `ADMIN` role
  - `/employees/{id}` - Users can only view their own records unless they're ADMIN
  - `/dashboard/**` requires authentication

---

## Database Schema

The `employee` table will have the following structure (auto-generated by Hibernate):

```sql
CREATE TABLE employee (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(255),
  username VARCHAR(255) NOT NULL UNIQUE,
  password VARCHAR(255),
  role_id BIGINT,
  FOREIGN KEY (role_id) REFERENCES role(id)
);
```

---

## Key Files Modified

1. **[Employee.java](src/main/java/com/example/payroll/Employee.java)** - Added unique constraint to username
2. **[LoginController.java](src/main/java/com/example/payroll/LoginController.java)** - Added registration endpoint
3. **[SecurityConfig.java](src/main/java/com/example/payroll/config/SecurityConfig.java)** - Opened registration endpoint
4. **[RoleRepository.java](src/main/java/com/example/payroll/role/RoleRepository.java)** - Updated findByName to return Optional

---

## Frontend Integration Example (React)

```javascript
// Register
const register = async (formData) => {
  const response = await fetch('http://localhost:8080/auth/register', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(formData),
  });
  return await response.json();
};

// Login
const login = async (username, password) => {
  const response = await fetch('http://localhost:8080/auth/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, password }),
  });
  return await response.json();
};
```

---

## Notes
- Ensure your database has the `role` table populated with at least "USER" and "ADMIN" roles
- The `spring.jpa.hibernate.ddl-auto=update` setting will automatically create/update the database schema
- All HTTP status codes follow REST conventions (201 for created, 400 for bad request, 409 for conflict, etc.)
